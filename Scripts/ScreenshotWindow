#!/usr/bin/env bash

STATE_FILE="$HOME/Scripts/.Screenshare-ON"
TOGGLE="ToggleScreenShare"

# Track whether we enabled screensharing
DID_ENABLE=false

# Enable screensharing if currently disabled
if [ ! -f "$STATE_FILE" ]; then
    "$TOGGLE" toggle
    DID_ENABLE=true
fi

sleep 0.02

hyprshot -m window -m active -o ~/Pictures/Screenshots/ --silent &

HYPRSHOT_PID=$!

# Wait until screencopy disappears
while hyprctl clients | grep -qi screencopy; do
    sleep 0.01
done

wait "$HYPRSHOT_PID" 2>/dev/null

# Restore state ONLY if we changed it
if [ "$DID_ENABLE" = true ]; then
    "$TOGGLE" toggle
fi
