#!/usr/bin/env bash
set -euo pipefail

DOTFILES="$HOME/.dotfiles"
CONF="$HOME/Scripts/Dotfiles.conf"

# 1️⃣ Sync dotfiles
while read -r SRC; do
    [[ -z "${SRC:-}" || "${SRC:0:1}" == "#" ]] && continue
    SRC="${SRC%\"}"
    SRC="${SRC#\"}"
    SRC=$(eval echo "$SRC")
    DEST="$DOTFILES/${SRC#$HOME/}"
    [ ! -e "$SRC" ] && echo "Skipping missing: $SRC" && continue
    mkdir -p "$(dirname "$DEST")"
    if [ -d "$SRC" ]; then
        rsync -a --delete "$SRC/" "$DEST/"
    else
        cp -a "$SRC" "$DEST"
    fi
done < "$CONF"

cd "$DOTFILES"

# 2️⃣ Stage all changes
git add .

# 3️⃣ Commit if there are changes
if git diff-index --quiet HEAD --; then
    echo "No changes to commit"
else
    git commit -m "Auto-sync dotfiles"
fi

# 4️⃣ Fetch and rebase remote
git fetch origin
git rebase origin/main

# 5️⃣ Push to GitHub
git push
